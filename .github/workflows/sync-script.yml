name: Sync Install Script to Server

# 触发条件：仅当 main 分支下的 version 文件内容发生变动并推送时触发
on:
  push:
    branches:
      - main
    paths:
      - 'version'

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. 获取仓库代码
      - name: Checkout Code
        uses: actions/checkout@v4

      # 2. 准备发布文件（将 install.sh 复制并重命名为 vsk.sh）
      - name: Prepare Script
        run: |
          cp install.sh vsk.sh
          echo "Prepared vsk.sh for deployment"

      # 3. 通过 SCP 同步文件到服务器（使用密码模式）
      - name: Copy vsk.sh via SCP
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SERVER_PASSWORD }}
          source: "vsk.sh"
          target: ${{ secrets.REMOTE_PATH }}
          strip_components: 0

      # 4. 通过 SSH 执行命令设置权限、用户组
      - name: Set Permissions and Ownership on Server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SERVER_PASSWORD }}
          script: |
            TARGET_FILE="${{ secrets.REMOTE_PATH }}/vsk.sh"
            
            if [ -f "$TARGET_FILE" ]; then
              # 1. 设置文件权限为 0755 (所有者读写执行，组/其他读执行)
              chmod 0755 "$TARGET_FILE"
              
              # 2. 设置用户组为 root:root (UID 0 / GID 0)
              chown root:root "$TARGET_FILE"
              
              echo "✅ 同步成功：vsk.sh 已就绪，权限已设为 0755，用户组已设为 root:root"
              ls -l "$TARGET_FILE"
            else
              echo "❌ 错误：在目标路径未找到 vsk.sh"
              exit 1
            fi