#!/usr/bin/env bash

# ==============================================================================
# VpsScriptKit - 通用检测工具
#
# @文件路径: lib/check.sh
# @功能描述: 负责 “查” (环境检测、软件检测、依赖安装)
#
# 设计原则：
# - 只提供“判断”，不做任何操作
#
# @作者: Jamison
# @版本: 0.1.0
# @创建日期: 2026-01-06
# ==============================================================================

# ------------------------------------------------------------------------------
# 函数名: is_root
# 功能:   判断当前用户是否为 root
# 
# 参数:
#   无
# 
# 返回值: 
#    0 - root
#    1 - 非 root
# 
# 示例:
#   is_root
# ------------------------------------------------------------------------------
is_root() {
	[ "$(id -u)" -eq 0 ]
}

# ------------------------------------------------------------------------------
# 校验是否为整数
# 健壮性: 利用正则判断，涵盖负数情况
# ------------------------------------------------------------------------------
is_integer() {
    [[ "$1" =~ ^-?[0-9]+$ ]]
}

# ------------------------------------------------------------------------------
# 校验变量是否为空
# ------------------------------------------------------------------------------
is_empty() {
    [[ -z "${1:-}" ]]
}

# ------------------------------------------------------------------------------
# 函数名: has_cmd
# 功能:   判断指定的命令是否存在于系统 PATH 中
# 
# 参数:
#   $1 (string): 命令名称 (如 wget, curl, git) (必填)
# 
# 返回值:
#   0 - [成功时的含义]
#   1 - [失败时的含义]
# 
# 示例:
#   if has_cmd "curl"; then
#       curl -I https://google.com
#   fi
# ------------------------------------------------------------------------------
has_cmd() {
	command -v "$1" >/dev/null 2>&1
}

# ------------------------------------------------------------------------------
# 网络连通性检查 (比 ping 更快，不依赖 ICMP)
# 很多 VPS 禁 ping，用 nc 或 curl 检查 Google/Cloudflare 端口更稳
# ------------------------------------------------------------------------------
has_internet() {
    # 尝试连接 Cloudflare DNS (1.1.1.1) 的 53 或 80 端口，超时 3 秒
    if has_cmd "nc"; then
        nc -z -w 3 1.1.1.1 53 >/dev/null 2>&1
    elif has_cmd "curl"; then
        curl -s --connect-timeout 3 https://1.1.1.1 >/dev/null 2>&1
    else
        # 降级方案
        ping -c 1 -W 3 1.1.1.1 >/dev/null 2>&1
    fi
}