#!/usr/bin/env bash

# ==============================================================================
# VpsScriptKit - 网络状态检测
#
# @文件路径: lib/network.sh
# @功能描述: 提供获取宿主机网络相关信息内容
#
# @作者: Jamison
# @版本: 1.0.0
# @创建日期: 2025-12-30
# ==============================================================================

# ******************************************************************************
# 公网 / 内网 IP
# ******************************************************************************

# ------------------------------------------------------------------------------
# 函数名: net_get_ipv4
# 功能:   获取公网 IPv4
# 
# 参数:
#   无
# 
# 返回值:
#   ip: IPv4 公网地址
#   ip: 未检测到公网 IPv4
# 
# 示例:
#   net_get_ipv4
# ------------------------------------------------------------------------------
net_get_ipv4() {
    local ip
    # 首选使用 https://ipinfo.io/ip，备选使用其他接口
    ip=$(curl -s4 --max-time 2 https://ipinfo.io/ip || curl -s4 --max-time 2 https://api64.ipify.org || curl -s4 --max-time 2 https://4.icanhazip.com)
    
    if [[ -z "$ip" ]]; then
        print_echo "未检测到公网 IPv4"
    else
        print_echo "$ip"
    fi
}

# ------------------------------------------------------------------------------
# 函数名: net_get_ipv6
# 功能:   获取公网 IPv6
# 
# 参数:
#   无
# 
# 返回值:
#   ip: IPv6 公网地址
#   ip: 未检测到公网 IPv6
# 
# 示例:
#   net_get_ipv6
# ------------------------------------------------------------------------------
net_get_ipv6() {
    local ip
    # 尝试通过支持 IPv6 的接口获取，并保留您提供的 grep ':' 逻辑进行校验
    ip=$(curl -s6 --max-time 2 https://ipinfo.io/ip || curl -s6 --max-time 2 https://6.icanhazip.com || curl -s6 --max-time 2 https://4.icanhazip.com)
    
    if [[ "$ip" == *":"* ]]; then
        print_echo "$ip"
    else
        print_echo "未检测到公网 IPv6"
    fi
}

# ------------------------------------------------------------------------------
# 函数名: net_get_private_ipv4
# 功能:   获取内网 IPv4
# 
# 参数:
#   无
# 
# 返回值:
#   ip: IPv4 内网地址
#   ip: 未检测到内网 IPv4
# 
# 示例:
#   net_get_private_ipv4
# ------------------------------------------------------------------------------
net_get_private_ipv4() {
    local ip
    ip=$(hostname -I 2>/dev/null | awk '{print $1}' | xargs)
    if [[ -z "$ip" ]]; then
        print_echo "未检测到内网 IPv4"
    else
        print_echo "$ip"
    fi
}

# ------------------------------------------------------------------------------
# 函数名: net_get_private_ipv6
# 功能:   获取内网 IPv6
# 
# 参数:
#   无
# 
# 返回值:
#   ip: IPv6 内网地址
#   ip: 未检测到内网 IPv6
# 
# 示例:
#   net_get_private_ipv6
# ------------------------------------------------------------------------------
net_get_private_ipv6() {
    local ip
    # 优先获取网卡上的全局 IPv6 地址
    ip=$(ip -6 addr show scope global | grep inet6 | awk '{print $2}' | cut -d'/' -f1 | head -n 1 | xargs)
    
    # 如果没找到全局地址，再找本地地址
    if [[ -z "$ip" ]]; then
        ip=$(ip -6 addr show | grep -E 'inet6 (fe80|fc00|fd00)' | awk '{print $2}' | cut -d'/' -f1 | head -n 1 | xargs)
    fi

    if [[ -z "$ip" ]]; then
        print_echo "未检测到内网 IPv6"
    else
        print_echo "$ip"
    fi
}

# ******************************************************************************
# 网络基础信息
# ******************************************************************************

# ------------------------------------------------------------------------------
# 函数名: net_get_gateway
# 功能:   获取默认网关
# 
# 参数:
#   无
# 
# 返回值:
#   成功: 网关地址
#   失败: N/A
# 
# 示例:
#   net_get_gateway
# ------------------------------------------------------------------------------
net_get_gateway() {
    # 解析默认网关
    ip route | awk '/default/ {print $3}' || echo "N/A"
}

# ------------------------------------------------------------------------------
# 函数名: net_get_dns
# 功能:   获取 DNS 服务器
# 
# 参数:
#   无
# 
# 返回值:
#   成功: DNS 地址
#   失败: N/A
# 
# 示例:
#   net_get_dns
# ------------------------------------------------------------------------------
net_get_dns() {
    # 从 /etc/resolv.conf 解析 DNS
    grep '^nameserver' /etc/resolv.conf | awk '{print $2}' || echo "N/A"
}


# ******************************************************************************
# 网络统计
# ******************************************************************************

# ------------------------------------------------------------------------------
# 函数名: _net_format_traffic
# 功能:   内部工具: 流量单位转换
# 
# 参数:
#   无
# 
# 返回值:
#   流量明细
# 
# 示例:
#   _net_format_traffic
# ------------------------------------------------------------------------------
_net_format_traffic() {
    local bytes=$1
    # 使用 awk 进行单位转换，保持两位小数
    awk -v b="$bytes" 'BEGIN {
        if (b < 1024) {
            printf "%.2fB", b
        } else if (b < 1048576) {
            printf "%.2fK", b/1024
        } else if (b < 1073741824) {
            printf "%.2fM", b/1048576
        } else {
            printf "%.2fG", b/1073741824
        }
    }'
}

# ------------------------------------------------------------------------------
# 函数名: net_get_total_rx
# 功能:   获取总接收流量
# 
# 参数:
#   无
# 
# 返回值:
#   总接收流量
# 
# 示例:
#   net_get_total_rx
# ------------------------------------------------------------------------------
net_get_total_rx() {
    # 统计所有网卡（排除 lo）的接收字节 (第2列)
    local total_rx
    total_rx=$(awk '/:/ {if($1 != "lo:") rx += $2} END {print rx}' /proc/net/dev)
    _net_format_traffic "${total_rx:-0}"
}

# ------------------------------------------------------------------------------
# 函数名: net_get_total_tx
# 功能:   获取总发送流量
# 
# 参数:
#   无
# 
# 返回值:
#   总发送流量
# 
# 示例:
#   net_get_total_tx
# ------------------------------------------------------------------------------
net_get_total_tx() {
    # 统计所有网卡（排除 lo）的发送字节 (第10列)
    local total_tx
    total_tx=$(awk '/:/ {if($1 != "lo:") tx += $10} END {print tx}' /proc/net/dev)
    _net_format_traffic "${total_tx:-0}"
}

# ******************************************************************************
# TCP / 队列参数
# ******************************************************************************

# ------------------------------------------------------------------------------
# 函数名: net_get_congestion_control
# 功能:   获取 TCP 拥塞控制算法
# 
# 参数:
#   无
# 
# 返回值:
#   TCP 拥塞控制算法
# 
# 示例:
#   net_get_congestion_control
# ------------------------------------------------------------------------------
net_get_congestion_control() {
    # 返回如 bbr, cubic, reno 等
    sysctl -n net.ipv4.tcp_congestion_control 2>/dev/null || echo "N/A"
}

# ------------------------------------------------------------------------------
# 函数名: net_get_qdisc
# 功能:   获取默认队列规程 (qdisc)
# 
# 参数:
#   无
# 
# 返回值:
#   默认队列规程 (qdisc)
# 
# 示例:
#   net_get_qdisc
# ------------------------------------------------------------------------------
net_get_qdisc() {
    # 返回如 fq, fq_codel, noop 等
    sysctl -n net.core.default_qdisc 2>/dev/null || echo "N/A"
}

# ------------------------------------------------------------------------------
# 函数名: net_region
# 功能:   检测网络环境
# 
# 参数:
#   无
# 
# 返回值:
#   CN     - 中国大陆
#   Global - 全球/境外
# 
# 示例:
#   local region
#   region=$(net_region)
# ------------------------------------------------------------------------------
net_region() {
    # 优先检测 Google (超时设为 2秒，提高效率)
    if curl -s --connect-timeout 2 -I https://www.google.com >/dev/null 2>&1; then
        print_echo "Global"
        return 0
    fi
    
    # Google 连不通，检测百度
    if curl -s --connect-timeout 2 -I https://www.baidu.com >/dev/null 2>&1; then
        print_echo "CN"
        return 0
    fi
    
    # 啥都不行，啥玩意网络啊
    print_echo "UNKNOWN"
}
