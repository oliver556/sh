#!/usr/bin/env bash

### ============================================================
# VpsScriptKit - 通用工具 - 函数库
# @名称:         utils.sh
# @职责:
# 1. 提供模块通用功能函数
# 2. 支持系统判断、输入验证、等待、路径处理等
# 3. 不包含业务逻辑
#
# @作者:         Jamison
# @版本:         0.1.0
# @创建日期:     2025-12-31
# @修改日期:     2025-01-04
#
# @许可证:       MIT
### ============================================================

# ------------------------------
# 输入校验
# ------------------------------

# TODO 后续删掉
is_number() {
  # 参数 $1：输入值
  # 返回 0 表示是纯数字，1 表示不是
  [[ "$1" =~ ^[0-9]+$ ]]
}

# ------------------------------
# 路径处理
# ------------------------------

resolve_path() {
  # 参数 $1：待解析的路径
  local path="$1"

  # 循环解析软链接，直到找到真实路径
  while [ -L "$path" ]; do
    local dir
    # 获取当前软链接目录
    dir="$(cd -P "$(dirname "$path")" && pwd)"
    # 读取软链接指向
    path="$(readlink "$path")"
    # 如果是相对路径，补全
    [[ "$path" != /* ]] && path="$dir/$path"
  done

  # 返回最终绝对路径
  cd -P "$(dirname "$path")" && pwd
}

# ------------------------------
# 日期时间函数
# ------------------------------

current_time() {
  # 返回当前时间，格式 YYYY-MM-DD HH:MM:SS
  date "+%Y-%m-%d %H:%M:%S"
}

# ------------------------------
# 命令存在性检查
# ------------------------------

command_exists() {
  # 参数 $1：命令名
  local cmd="$1"

  # 使用 type 命令判断是否存在
  if type "$cmd" >/dev/null 2>&1; then
    return 0
  else
    return 1
  fi
}

# ------------------------------
# 读取用户确认
# ------------------------------

confirm() {
  # 参数 $1：提示文字
  local prompt="$1"
  local response

  while true; do
    # 输出提示并读取用户输入
    read -rp "$prompt [y/n]: " response
    case "$response" in
      [Yy]* ) return 0 ;;  # 确认，返回 0
      [Nn]* ) return 1 ;;  # 否认，返回 1
      * ) echo "请输入 y 或 n" ;;  # 其他输入重复提示
    esac
  done
}

# ------------------------------
# 检查文件或目录是否存在
# ------------------------------

file_exists() {
  # 参数 $1：文件路径
  [[ -f "$1" ]]
}

dir_exists() {
  # 参数 $1：目录路径
  [[ -d "$1" ]]
}

# ------------------------------
# 安全执行命令
# ------------------------------

safe_exec() {
  # 参数 $@：命令及参数
  # 如果命令失败，打印时间戳和错误，但不退出脚本
  "$@"
  local status=$?
  if [[ $status -ne 0 ]]; then
    echo "$(current_time) ❌ 命令执行失败: $*"
  fi
  return $status
}

# ------------------------------
# 追加日志
# ------------------------------

log_append() {
  # 参数 $1：日志内容
  local msg="$1"

  # 如果日志目录存在，则写入日志文件
  if [[ -d "$VSK_LOG_DIR" ]]; then
    echo "$(current_time) $msg" >> "$VSK_LOG_DIR/vpsscriptkit.log"
  fi
}

# ------------------------------
# 辅助函数: 获取 Docker 环境状态字符串
# ------------------------------
get_docker_status_text() {
  # 调用 lib/check.sh 中的逻辑函数
  if docker_is_installed; then
    # 返回绿色加粗的“已安装”
    echo -e "${BOLD_GREEN}已安装${RESET}"
  else
    # 返回红色加粗的“未安装”
    echo -e "${BOLD_RED}未安装${RESET}"
  fi
}
