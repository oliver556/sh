#!/usr/bin/env bash

# =================================================================================
# VpsScriptKit - 交互确认工具 - 函数库
# @名称:         confirm_utils.sh
# @位置:        lib/confirm_utils.sh
# @作者:         Jamison
# @版本:         0.1.0
# @创建日期:     2025-12-30
# @修改日期:     2025-01-04
#
# @许可证:       MIT
### ============================================================

# ---------------------------------------------------------------------------------
# 函数: ui_confirm
# 描述: 按 (Y/y) 键确认，按其它任意键返回/取消
# 参数: $1 - 提示信息 (默认: 确认执行此操作吗？)
# 返回: 0 (确认), 1 (取消)
# ---------------------------------------------------------------------------------
ui_confirm() {
    local title="$1"
    local user_choice

    echo
    # 如果 title 不为空，则显示具体的标题提示
    if [ -n "$title" ]; then
        echo -e "按 ${BOLD_RED}(Y/y)${LIGHT_WHITE} 键确认执行 ${LIGHT_CYAN}${title}${LIGHT_WHITE}，按其它任意键返回。"
    else
        echo -e "按 ${BOLD_RED}(Y/y)${LIGHT_WHITE} 键确认执行，按其它任意键返回。"
    fi
    echo

    # 使用 read -rp 获取输入，支持 ANSI 颜色渲染提示符
    read -rp "$(echo -e "${LIGHT_CYAN}👉 请输入你的选择: ${LIGHT_WHITE}")" user_choice

    case "$user_choice" in
        y|Y)
            return 0  # 返回 0, 代表“成功/继续”
            ;;
        *)
            echo -e "\n${BOLD_YELLOW}操作已取消...${LIGHT_WHITE}"
            sleep 1
            return 1  # 返回 1, 代表“失败/取消”
            ;;
    esac
}

# ---------------------------------------------------------------------------------
# 函数: ui_wait_enter
# 描述: 任务终结时的确认，必须按“回车键”才能继续。
# ---------------------------------------------------------------------------------
ui_wait_enter() {
    ui blank
    ui blank
    ui echo "${LIGHT_GREEN}执行完成${RESET}"
    ui echo "${LIGHT_WHITE}按回车键返回...${RESET}"
    # 不带 -n，强制等待回车
    read -s -r
}

# ---------------------------------------------------------------------------------
# 函数: ui_wait (整合了之前的 pause 逻辑)
# 描述: 流程中的临时暂停，按“任意键”立即继续 (无需回车)。
# ---------------------------------------------------------------------------------
ui_wait() {
    ui blank
    # 使用简洁的提示语，兼容 pause 的感觉
    ui echo "${LIGHT_CYAN}按任意键继续...${RESET}"

    # -n 1: 读取 1 个字符立即返回
    # -s: 静默模式，不回显输入
    # -r: 允许反斜杠
    read -n 1 -s -r
}

# ---------------------------------------------------------------------------------
# 函数: ui_input
# 描述: 获取用户输入的文本数据。支持设置默认值。
# 参数: $1 - 提示语, $2 - 默认值 (可选)
# ---------------------------------------------------------------------------------
ui_input() {
    local prompt="$1"
    local default_val="$2"
    local input_val
    
    # 提示符通过 read -p 输出到 stderr，确保 $() 只能捕获到 echo 的值
    if [ -n "$default_val" ]; then
        read -rp "$(echo -e "${LIGHT_CYAN}👉 ${prompt} [默认: ${BOLD_WHITE}${default_val}${LIGHT_CYAN}]: ${RESET}")" input_val
        echo "${input_val:-$default_val}"
    else
        read -rp "$(echo -e "${LIGHT_CYAN}👉 ${prompt}: ${RESET}")" input_val
        echo "$input_val"
    fi
}

# ---------------------------------------------------------------------------------
# 函数: ui_read_choice
# 描述: 专门用于菜单选择的读取。作为 ui_input 的快捷封装。
# ---------------------------------------------------------------------------------
ui_read_choice() {
    # 统一调用 ui_input，保持界面指引符和逻辑的一致性
    ui_input "请输入选项"
}

# ---------------------------------------------------------------------------------
# 状态反馈函数
# ---------------------------------------------------------------------------------
# 普通信息提示
ui_info()  {
    ui echo "${BOLD_BLUE}ℹ${RESET} $1";
}
# 成功信息提示
ui_success() {
    ui echo "${BOLD_GREEN}✔${RESET} $1";
}
# 警告信息提示
ui_warn()  {
     ui echo "${BOLD_YELLOW}⚠${RESET} $1";
}
# 错误信息提示
ui_error() {
    ui echo "${BOLD_RED}✘${RESET} $1"; 
}

# ---------------------------------------------------------------------------------
# 函数: ui_exit
# 描述: 打印告别语并退出脚本
# ---------------------------------------------------------------------------------
ui_exit() {
    ui clear
    ui line
    echo -e "${BOLD_GREEN}👋 感谢使用 VpsScriptKit！${LIGHT_WHITE}"
    echo -e "${BOLD_CYAN}👋 江湖有缘再见。${RESET}"
    ui line
    sleep 1
    ui clear
    exit 0
}
