#!/usr/bin/env bash

# ==============================================================================
# VpsScriptKit - UI è¾“å‡ºä¸ç•Œé¢æ¸²æŸ“å·¥å…·
#
# @æ–‡ä»¶è·¯å¾„: lib/ui.sh
# @åŠŸèƒ½æè¿°: è´Ÿè´£ â€œç”»â€ (UI æ¸²æŸ“ã€èœå•é¡¹ã€é¢œè‰²ã€é—´è·)
# 
# è®¾è®¡åŸåˆ™ï¼š
# - åªè´Ÿè´£â€œæ˜¾ç¤ºâ€å’Œâ€œè¾“å…¥â€
# - ä¸åŒ…å«ä»»ä½•ä¸šåŠ¡é€»è¾‘
# - ä¸åšä»»ä½•ç³»ç»Ÿæ“ä½œ
#
# @ä½œè€…: Jamison
# @ç‰ˆæœ¬: 0.1.0
# @åˆ›å»ºæ—¥æœŸ: 2025-12-31
# ==============================================================================

# ------------------------------------------------------------------------------
# å‡½æ•°å: ui
# åŠŸèƒ½:   ç»¼åˆæ‰“å°å°è£…å‡½æ•° (åˆ†å‘å™¨æ¨¡å¼)
# 
# å‚æ•°:
#   $1 (number): é“¾å¼è°ƒç”¨æ—¶æ‰€è¾“å…¥çš„å€¼
# 
# è¿”å›å€¼: æ‰§è¡Œå¯¹åº”åŠŸèƒ½
# 
# ç¤ºä¾‹:
#   ui echo "$1"
# ------------------------------------------------------------------------------
ui() {
    local action="$1"
    shift # å¼¹å‡ºç¬¬ä¸€ä¸ªå‚æ•° (å¦‚ "print", "clean", "echo" ç­‰)

    case "$action" in
        # ------------------------------
        # åŸºç¡€è¾“å‡º (å†…å¤–ç»Ÿä¸€è°ƒç”¨)
        # ------------------------------
        "echo")
        # ç»Ÿä¸€ echo è¾“å‡ºï¼Œç¡®ä¿æ”¯æŒè½¬ä¹‰å­—ç¬¦
        if [[ "$1" == "-n" ]]; then
            shift
            echo -ne "$*"
        else
            echo -e "$*"
         fi
        ;;

        # ------------------------------
        # è¾“å‡ºä¸€ä¸ªç©ºè¡Œ
        # ------------------------------
        "blank")
            ui echo ""
            ;;

        # ------------------------------
        # åˆ†éš”çº¿ä¸è¾¹æ¡†ï¼Œç”¨äºåˆ†éš”å†…å®¹
        # ------------------------------
        
        # æ ·å¼ 1 é»˜è®¤/é€šç”¨æ¨ªçº¿ (å¯¹åº” ui_tip / æ™®é€šåˆ†éš”) -> æ¨èç”¨ é’è‰²æˆ–æ·¡ç°ï¼Œä¸è¦å¤ªæŠ¢çœ¼
        "line" | "line_tip")
            ui echo "${LIGHT_CYAN}â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${RESET}"
            ;;

        # ä¿¡æ¯æ¨ªçº¿ (å¯¹åº” ui_info) -> è“è‰²
        "line_info")
            ui echo "${LIGHT_BLUE}â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${RESET}"
            ;;

        # æˆåŠŸæ¨ªçº¿ (å¯¹åº” ui_success) -> ç»¿è‰²
        "line_success")
            ui echo "${LIGHT_GREEN}â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${RESET}"
            ;;

        # è­¦å‘Šæ¨ªçº¿ (å¯¹åº” ui_warn) -> é»„è‰²
        "line_warn")
            ui echo "${YELLOW}â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${RESET}"
            ;;

        # é”™è¯¯æ¨ªçº¿ (å¯¹åº” ui_error) -> çº¢è‰²
        "line_error")
            ui echo "${LIGHT_RED}â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${RESET}"
            ;;
        
        "line_2")
            # æ ·å¼ 2
            ui echo  ${LIGHT_CYAN}"--------------------------------------------------------------"${RESET}
            ;;

        "line_3")
            # æ ·å¼ 3
            ui echo ${BOLD_RED}"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"${RESET}
            ;;

        # æ ·å¼ 4ï¼ˆé¡¶éƒ¨è¾¹æ¡†ï¼‰
         "border_top")
            ui echo  ${LIGHT_CYAN}"+============================================================+"${RESET}
            ;;

        # æ ·å¼ 5ï¼ˆåº•éƒ¨è¾¹æ¡†ï¼‰
        "border_bottom")
            ui echo ${LIGHT_CYAN}"=============================================================="${RESET}
            ;;

        # ------------------------------
        # é¡µé¢æ‰“å°
        # ------------------------------
        "print")
            local action2="$1" # æ­¤æ—¶ $1 æ˜¯åŸæ¥çš„ $2 (å¦‚ "tip")
            shift # å¼¹å‡ºç¬¬äºŒä¸ªå‚æ•°

            case "$action2" in
                # ------------------------------
                # é¦–é¡µ / é—¨æˆ·é¡µ
                # ------------------------------
                "home_header")
                    # å‚æ•° 1: æ ‡é¢˜æ–‡å­—
                    local title="$1"

                    ui border_top

                    ui echo "${LIGHT_CYAN}#${BOLD}$(printf "$title")${RESET}"

                    ui border_top
                    ;;
            
                # ------------------------------
                # åŠŸèƒ½é¡µ / å­èœå•é¡µ
                # ------------------------------
                "page_header")
                    # å‚æ•° 1ï¼šé¡µé¢æ ‡é¢˜
                    local title="$1"

                    ui border_top

                    # ä»å·¦å¼€å§‹è¾“å‡ºï¼Œä¸å±…ä¸­
                    ui echo "# ${LIGHT_CYAN}${BOLD}${title}${RESET}"

                    ui border_top
                    ;;

                # ------------------------------
                # æŸ¥è¯¢ / ä¿¡æ¯å±•ç¤ºé¡µé¡¶éƒ¨
                # ------------------------------
                "info_header")
                    # å‚æ•° 1ï¼šä¿¡æ¯é¡µæ ‡é¢˜
                    local title="$1"

                    # è¾“å‡ºé¡¶éƒ¨è¾¹æ¡†
                    ui border_top

                    # ç”¨ä¸åŒçš„é£æ ¼è¾“å‡ºæ ‡é¢˜
                    # ä¾‹å¦‚ï¼šç»¿è‰² + åŠ ç²— + å·¦å¯¹é½ + å°¾éƒ¨è¡¥å……æ¨ªçº¿ï¼ŒåŒºåˆ†é—¨æˆ·é¡µå’Œå­èœå•é¡µ
                    ui echo "# ${LIGHT_GREEN}${BOLD}${title}${RESET}"

                    # å†è¾“å‡ºä¸€æ¬¡è¾¹æ¡†
                    ui border_top
                    ;;

                # ------------------------------
                # è¯¦æƒ…é¡µ / ä¿¡æ¯å±•ç¤ºé¡¶éƒ¨ (æœªå¼€å‘)
                # ------------------------------
                "page_header_full")
                    # å‚æ•° 1ï¼šé¡µé¢æ ‡é¢˜
                    local title="$1"

                    # å†…å®¹åŒºå›ºå®šå®½åº¦ï¼ˆå’Œ ui border_top å¯¹é½ï¼‰
                    local content_width=60

                    ui border_top

                    # è®¡ç®—æ ‡é¢˜çš„æ˜¾ç¤ºå®½åº¦ï¼ˆè€Œä¸æ˜¯å­—ç¬¦é•¿åº¦ï¼‰
                    local title_width
                    title_width=$(ui_str_width "$title")

                    # å³ä¾§éœ€è¦è¡¥çš„ç©ºæ ¼æ•°
                    local pad=$((content_width - 2 - title_width))
                    ((pad < 0)) && pad=0

                    # è¾“å‡ºæ ‡é¢˜è¡Œï¼ˆå·¦å¯¹é½ï¼Œå³ä¾§è‡ªåŠ¨è¡¥ç©ºæ ¼ï¼‰
                    printf "# %s%*s\n" \
                        "${LIGHT_CYAN}${BOLD}${title}${RESET}" \
                        "$pad" ""

                    ui border_top
                    ;;

                # ------------------------------
                # é¦–é¡µ / æç¤ºè¡Œ
                # ------------------------------
                "tip")
                    # æ­¤æ—¶ $1 æ˜¯åŸæ¥çš„ $3 (æç¤ºæ–‡å­—å†…å®¹)
                    local tip="$1"
                    ui echo "${LIGHT_YELLOW}#$(printf "$tip")${RESET}"
                    ;;

                *)
                    ui_warn_menu "æ— æ•ˆé€‰é¡¹ï¼Œè¯·é‡æ–°è¾“å…¥..."
                    ;;
            esac
            ;;

        # ------------------------------
        # é¡µé¢æ¸…å±
        # ------------------------------
        "clear")
            clear
            ;;

        # ------------------------------
        # èœå•é¡¹æ¸²æŸ“
        # ------------------------------
        "item")
            local index="$1"
            local text="$2"

            # æœ€å¤§ç¼–å·é•¿åº¦ï¼ˆå¦‚ä¸»èœå•æœ€å¤§æ˜¯ 99ï¼Œåˆ™ max_index_len=2ï¼‰
            local max_index_len=2

            # å½“å‰ç¼–å·é•¿åº¦
            local index_len=${#index}

            # ç©ºæ ¼æ•°é‡ = æœ€å¤§ç¼–å·é•¿åº¦ - å½“å‰ç¼–å·é•¿åº¦ + 1 (1 è¡¨ç¤ºç¼–å·åè‡³å°‘ä¸€ä¸ªç©ºæ ¼)
            local pad=$((max_index_len - index_len + 1))
            local spaces=$(printf '%*s' "$pad" '')

            # è¾“å‡ºèœå•
            ui echo "${LIGHT_CYAN}${index}.${spaces}${RESET}${LIGHT_WHITE}${text}${RESET}"
            ;;

        # ------------------------------
        # å±•ç¤ºåˆ—è¡¨
        # ------------------------------

        "item_list")
            # å‚æ•° 1ï¼šæ ‡ç­¾åç§° (Label)
            # å‚æ•° 2ï¼šå¯¹é½å®½åº¦ / å†’å·åçš„ç©ºæ ¼æ•° (é»˜è®¤ 15)
            # å‚æ•° 3ï¼šå±•ç¤ºçš„å†…å®¹ (Value)
            local label="$1"
            local width="${2:-15}"
            local value="$3"

            # æ›´åŠ å¥å£®çš„æ˜¾ç¤ºå®½åº¦è®¡ç®—æ–¹å¼ (æ”¯æŒ UTF-8 ä¸­è‹±æ–‡æ··æ’)
            # è·å–å­—ç¬¦æ•°
            local char_len=${#label}
            # è·å–å­—èŠ‚æ•°
            local byte_len=$(printf "%s" "$label" | wc -c)

            # è§†è§‰å®½åº¦ç®—æ³•ï¼šå­—ç¬¦æ•° + (å­—èŠ‚æ•° - å­—ç¬¦æ•°) / 2
            # ä¸­æ–‡å­—ç¬¦å  3 å­—èŠ‚ï¼Œå­—ç¬¦æ•° 1ï¼Œè®¡ç®—ç»“æœä¸º 1 + (3-1)/2 = 2
            local label_w=$(( char_len + (byte_len - char_len) / 2 ))

            # è®¡ç®—éœ€è¦è¡¥å…¨çš„ç©ºæ ¼æ•° (ç›®æ ‡å®½åº¦ - æ ‡ç­¾å®é™…å®½åº¦)
            local pad=$((width - label_w))
            ((pad < 0)) && pad=0
            local spaces=$(printf '%*s' "$pad" '')

            # ç»Ÿä¸€è¾“å‡ºæ ¼å¼ï¼šæ ‡ç­¾(é’è‰²):[ç©ºæ ¼è¡¥é½]å†…å®¹(ç™½è‰²)
            ui echo "${BOLD_LIGHT_CYAN}${label}:${spaces}${BOLD_LIGHT_WHITE}${value}${RESET}"
            ;;

        *)
            ui_warn_menu "æ— æ•ˆé€‰é¡¹ï¼Œè¯·é‡æ–°è¾“å…¥..."
            ;;
    esac
}

# ------------------------------------------------------------------------------
# å‡½æ•°å: ui_str_width
# åŠŸèƒ½:   è®¡ç®—å­—ç¬¦ä¸²åœ¨ç»ˆç«¯ä¸­çš„æ˜¾ç¤ºå®½åº¦ (ä¸­2è‹±1)
# 
# å‚æ•°:
#   $1 (string): è¦æ˜¾ç¤ºçš„æ–‡æœ¬ (å¿…å¡«)
#   $2 ([ç±»å‹]): [æè¿°å‚æ•°2çš„å«ä¹‰]
# 
# è¿”å›å€¼: è®¡ç®—å­—ç¬¦ä¸²åœ¨ç»ˆç«¯ä¸­çš„æ˜¾ç¤ºå®½åº¦
# 
# ç¤ºä¾‹:
#   ui_str_width "$1"
# ------------------------------------------------------------------------------
# 
ui_str_width() {
    local str="$1"
    local width=0
    local char

    # æŒ‰å­—ç¬¦æ‹†åˆ†
    while IFS= read -r -n1 char; do
        # å¦‚æœæ˜¯ ASCIIï¼Œå®½åº¦ +1ï¼Œå¦åˆ™ +2
        if [[ "$char" =~ [[:ascii:]] ]]; then
            ((width+=1))
        else
            ((width+=2))
        fi
    done <<< "$str"

    echo "$width"
}

# ******************************************************************************
# çŠ¶æ€åé¦ˆ
# ******************************************************************************
# çº¯æ–‡æœ¬è¾“å‡ºï¼ˆæœ€ä½çº§ï¼‰
ui_text() {
    ui echo "$1"
}
# ç”¨æˆ·æç¤º / è¯´æ˜ï¼ˆåŠ ç²—ç™½ï¼‰-> ç”¨ç®­å¤´å¼•å¯¼
ui_tip() {
    ui echo "${BOLD_WHITE}âœ$(ui_spaces 1)$1${RESET}"
}
# ä¿¡æ¯æç¤ºï¼ˆä¸­æ€§çŠ¶æ€ï¼‰-> ç”¨å®å¿ƒåœ†ç‚¹æˆ– i
ui_info()  {
    ui echo "${BLUE}â—$(ui_spaces 1)$1${LIGHT_WHITE}"
}
# æˆåŠŸæç¤º(ç»¿) -> ç»å…¸çš„å¯¹å·
ui_success() {
    ui echo "${BOLD_GREEN}âœ”$(ui_spaces 1)$1${LIGHT_WHITE}"
}
# è­¦å‘Šæç¤ºï¼ˆéè‡´å‘½ï¼‰(é»„) -> å¹å·
ui_warn()  {
    ui echo "${BOLD_YELLOW}â–²$(ui_spaces 1)$1${LIGHT_WHITE}"
}
# é”™è¯¯æç¤ºï¼ˆè‡´å‘½ï¼‰(çº¢) -> ç»å…¸çš„å‰å·
ui_error() {
    ui echo "${BOLD_RED}âœ˜$(ui_spaces 1)$1${LIGHT_WHITE}"
}
# èœå•é€‰é¡¹é”™è¯¯ï¼ˆéè‡´å‘½ï¼‰
ui_warn_menu()  {
    ui echo "${BOLD_YELLOW}âœ–$(ui_spaces 1)$1${LIGHT_WHITE}"
}

# ==============================================================================
# ç›’å¼åé¦ˆ (å¸¦ä¸Šä¸‹è¾¹æ¡†çš„å¼ºè°ƒæ¨¡å¼)
# ==============================================================================
# æç¤ºæ ‡é¢˜ - ç›’å¼ï¼ˆå¸¸ç”¨äºæ‰§è¡Œè„šæœ¬æ—¶å¼€å¤´çš„æç¤ºï¼‰
ui_box_info() {
    ui line_info
    ui_success "$1"
    ui line_info
}
# æˆåŠŸ - ç›’å¼
ui_box_success() {
    ui line_success
    ui_success "$1"
    ui line_success
}

# é”™è¯¯ - ç›’å¼ (å¸¸ç”¨äºè„šæœ¬å‡ºé”™é€€å‡ºå‰)
ui_box_error() {
    ui line_error
    ui_error "$1"
    ui line_error
}

# è­¦å‘Š - ç›’å¼ (é‡è¦æ³¨æ„äº‹é¡¹)
ui_box_warn() {
    ui line_warn
    ui_warn "$1"
    ui line_warn
}

# ä¿¡æ¯ - ç›’å¼ (å¤§æ®µä¿¡æ¯å¼€å§‹å‰)
ui_box_info() {
    ui line_info
    ui_info "$1"
    ui line_info
}

# ------------------------------------------------------------------------------
# å‡½æ•°å: ui_exit
# åŠŸèƒ½:   è¾“å‡ºå‘Šåˆ«è¯­å¹¶é€€å‡ºè„šæœ¬
# 
# å‚æ•°: æ— 
# 
# è¿”å›å€¼: æ’åˆ—å¥½çš„ç»“æŸè¯­
# 
# ç¤ºä¾‹:
#   ui_exit
# ------------------------------------------------------------------------------
ui_exit() {
    ui clear
    ui line
    ui echo "${BOLD_GREEN}ğŸ‘‹$(ui_spaces)æ„Ÿè°¢ä½¿ç”¨ VpsScriptKitï¼${LIGHT_WHITE}"
    ui echo "${BOLD_CYAN}ğŸ‘‹$(ui_spaces)æ±Ÿæ¹–æœ‰ç¼˜å†è§ã€‚${LIGHT_WHITE}"
    ui line
    sleep 1
    ui clear
    exit 0
}

# ******************************************************************************
# å…¨å±€å˜é‡ï¼šç”¨äºè·Ÿè¸ªå½“å‰è¡Œ ID
# æä¾›ï¼šui_menu_itemã€ui_menu_done ä½¿ç”¨
# ******************************************************************************
G_LAST_MENU_ROW=-1

# ------------------------------------------------------------------------------
# å‡½æ•°å: ui_menu_item
# åŠŸèƒ½:   èœå•é¡¹æ¸²æŸ“ (æµå¼è¡Œæ§å¸ƒå±€)
# 
# å‚æ•°:
#   $1 (string): è¡Œæ ‡è¯†ç¬¦ (ç›¸åŒåˆ™ä¸æ¢è¡Œ) (å¿…å¡«)
#   $2 (string): è·ç¦»å·¦ä¾§æˆ–å‰ä¸€ä¸ªé¡¹çš„é—´è· (å¿…å¡«)
#   $3 (string): èœå•ç¼–å· (å¿…å¡«)
#   $4 (string): èœå•æ–‡æœ¬ (å¿…å¡«)
#   $5 (string): ç¼–å·åçš„é—´è· (å¯é€‰)
# 
# è¿”å›å€¼: é€‰ç„¶åçš„æ’ç‰ˆ
# 
# ç¤ºä¾‹:
#   ui_menu_item $1 $2 $3 $4 $5
# ------------------------------------------------------------------------------
ui_menu_item() {
    local row_id="$1"
    local padding="$2"
    local index="$3"
    local text="$4"
    local space_count="${5:-1}"

    # è‡ªåŠ¨æ¢è¡Œé€»è¾‘ï¼šå¦‚æœ row_id å˜åŒ–ï¼Œåˆ™è¾“å‡ºæ¢è¡Œç¬¦
    if [[ "$row_id" != "$G_LAST_MENU_ROW" ]]; then
        # å¦‚æœä¸æ˜¯ç¬¬ä¸€æ¬¡è°ƒç”¨ï¼Œåˆ™æ¢è¡Œ
        if [[ "$G_LAST_MENU_ROW" != "-1" ]]; then
            echo ""
        fi
        G_LAST_MENU_ROW="$row_id"
    fi

    # æ¸²æŸ“é—´è· (Padding)
    printf "%*s" "$padding" ""

    # æ¸²æŸ“èœå•å†…å®¹
    # æ ¼å¼: ç¼–å·. æ–‡æœ¬
    ui echo -n "${LIGHT_CYAN}${index}.${RESET}$(ui_spaces $space_count)${LIGHT_WHITE}${text}${RESET}"
}

# ------------------------------------------------------------------------------
# å‡½æ•°å: ui_menu_done
# åŠŸèƒ½:   å¼ºåˆ¶é‡ç½®è¡ŒçŠ¶æ€ (é€šå¸¸ç”¨äºèœå•ç»“æŸå) ä¸ ui_menu_item é…å¥—ä½¿ç”¨
# 
# å‚æ•°: æ— 
# 
# è¿”å›å€¼: 
#   1 - å…¨å±€å˜é‡ï¼šç”¨äºè·Ÿè¸ªå½“å‰è¡Œ ID
# 
# ç¤ºä¾‹:
#   ui_menu_done
# ------------------------------------------------------------------------------
ui_menu_done() {
    ui blank
    G_LAST_MENU_ROW=-1
}

# ------------------------------------------------------------------------------
# å‡½æ•°å: ui_go_level
# åŠŸèƒ½:   èœå•å±‚çº§è·³è½¬æç¤º
# 
# å‚æ•°: æ— 
# 
# è¿”å›å€¼: æ— 
# 
# ç¤ºä¾‹:
#   ui_go_level
# ------------------------------------------------------------------------------
ui_go_level() {
    ui border_bottom

    ui_menu_item 99 0 0 "è¿”å›ä¸Šçº§èœå•" 2

    ui_menu_done

    ui border_bottom
}