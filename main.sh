#!/usr/bin/env bash

# ==============================================================================
# VpsScriptKit - ä¸»å…¥å£
# 
# @æ–‡ä»¶è·¯å¾„: main.sh
# @åŠŸèƒ½æè¿°: ç¯å¢ƒåˆå§‹åŒ–ã€ä¾èµ–åŠ è½½ã€ä¸»èœå•æ¸²æŸ“ä¸è·¯ç”±åˆ†å‘
# 
# @ä½œè€…:    Jamison
# @ç‰ˆæœ¬:    1.0.0
# @åˆ›å»ºæ—¥æœŸ: 2026-01-09
# ==============================================================================

# ******************************************************************************
# Shell ç¯å¢ƒå®‰å…¨è®¾ç½®ï¼ˆå·¥ç¨‹çº§ï¼‰
# ******************************************************************************
# å¼€å¯é”™è¯¯è°ƒè¯•æ•æ‰ï¼šä¸€æ—¦å‡ºé”™ï¼Œæ‰“å°è¡Œå·å’Œé”™è¯¯å‘½ä»¤
# trap 'echo -e "\033[31m[Error] è„šæœ¬å¼‚å¸¸é€€å‡ºï¼å‡ºé”™è¡Œå·: $LINENOï¼Œé”™è¯¯å‘½ä»¤: $BASH_COMMAND\033[0m"' ERR

set -o errexit   # ä¸€æ—¦æœ‰å‘½ä»¤è¿”å›é 0ï¼Œç«‹å³é€€å‡ºè„šæœ¬ï¼Œé¿å…é”™è¯¯è¢«å¿½ç•¥
set -o pipefail  # ç®¡é“ä¸­ä»»æ„ä¸€æ®µå¤±è´¥ï¼Œæ•´ä½“å¤±è´¥ï¼Œé˜²æ­¢é”™è¯¯è¢«åæ‰
set -o nounset   # ä½¿ç”¨æœªå®šä¹‰å˜é‡æ—¶ç›´æ¥æŠ¥é”™ï¼Œé¿å…æ‹¼å†™é”™è¯¯å¯¼è‡´éšè”½ bug

# ******************************************************************************
# åŸºç¡€è·¯å¾„ä¸ç¯å¢ƒå®šä¹‰
# ******************************************************************************

# å¯¼å‡ºæ ¹ç›®å½• (å¦‚æœç¯å¢ƒå˜é‡æ²¡ä¼ ï¼Œåˆ™è‡ªåŠ¨è®¡ç®—)
export BASE_DIR="${BASE_DIR:-$(pwd)}"

# è¯»å–ç‰ˆæœ¬å· (ä»æ ¹ç›®å½• version æ–‡ä»¶è¯»å–ï¼Œæ–¹ä¾¿è‡ªåŠ¨æ›´æ–°åŒæ­¥)
VSK_VERSION=$(cat "${BASE_DIR}/version" | xargs)

# æš‚æ—¶ä¸åšæ—¥å¿—åŠŸèƒ½
# export VSK_LOG_DIR="${BASE_DIR}/logs"
# export VSK_DATA_DIR="${BASE_DIR}/data"

# ç¡®ä¿å¿…è¦ç›®å½•å­˜åœ¨
# mkdir -p "$VSK_LOG_DIR" "$VSK_DATA_DIR"
# mkdir -p "$VSK_DATA_DIR"

# ******************************************************************************
# åŠ è½½æ ¸å¿ƒå‡½æ•°åº“ (ä¾èµ–é¡ºåºï¼šos Â­Â­Â­-> env -> ui -> utils -> check -> others)
# ******************************************************************************

# å®šä¹‰æ ¸å¿ƒåº“åˆ—è¡¨ï¼ˆåŠ è½½é¡ºåºè‡³å…³é‡è¦ï¼Œenv å®šä¹‰å¸¸é‡ï¼Œutils æä¾›åŸºç¡€å·¥å…·ï¼Œui æä¾›ç•Œé¢ï¼‰
LIBS=(
    "os.sh"         # OS è¯†åˆ«æ¨¡å—ï¼ˆå¿…é¡»æœ€å…ˆï¼‰
    "env.sh"        # å…¨å±€ç¯å¢ƒå˜é‡ä¸å¸¸é‡é…ç½®
    "ui.sh"         # UI æ¸²æŸ“å·¥å…· - å‡½æ•°åº“
    "utils.sh"      # å…¨å±€é€šç”¨å·¥å…· - å‡½æ•°åº“
    "check.sh"      # é€šç”¨æ£€æµ‹å·¥å…· - å‡½æ•°åº“
    "network.sh"    # ç½‘ç»œä¿¡æ¯å·¥å…· - å‡½æ•°åº“
    "system.sh"     # ç³»ç»Ÿä¿¡æ¯å·¥å…· - å‡½æ•°åº“
    "validate.sh"   # èƒ½åŠ›æ£€æµ‹å·¥å…· - å‡½æ•°åº“
    "interact.sh"   # äº¤äº’ç¡®è®¤å·¥å…· - å‡½æ•°åº“ï¼ˆåŸ confirm_utils.shï¼‰
    "router.sh"     # è·¯ç”±æ¨¡å—å·¥å…· - å‡½æ•°åº“ï¼ˆåŸ core/router.shï¼‰
)

# å¾ªç¯åŠ è½½å¹¶æ£€æŸ¥ï¼Œé¿å… source ä¸å­˜åœ¨çš„æ–‡ä»¶å¯¼è‡´æŠ¥é”™é€€å‡º
for lib in "${LIBS[@]}"; do
    if [[ -f "${BASE_DIR}/lib/$lib" ]]; then
        source "${BASE_DIR}/lib/$lib"
    fi
done

# è¯»å–ç‰ˆæœ¬å· (ä»æ ¹ç›®å½• version æ–‡ä»¶è¯»å–ï¼Œæ–¹ä¾¿è‡ªåŠ¨æ›´æ–°åŒæ­¥) (å¦‚æœæ–‡ä»¶ä¸å­˜åœ¨åˆ™é»˜è®¤ Unknown)
VSK_VERSION=$(cat "${BASE_DIR}/version" 2>/dev/null || echo "Unknown")

# ******************************************************************************
# ä¿¡å·æ•æ‰ä¸æ¸…ç†
# ******************************************************************************

# ------------------------------------------------------------------------------
# å‡½æ•°å: _cleanup
# åŠŸèƒ½:  æ•æ‰é”™è¯¯çš„é€€å‡º
# 
# å‚æ•°: æ— 
# 
# è¿”å›å€¼:
#   0 - é”™è¯¯æ—¶çš„ä¿¡æ¯æç¤º
# 
# ç¤ºä¾‹:
#   _cleanup
# ------------------------------------------------------------------------------
_cleanup() {
  ui_exit
}
trap _cleanup SIGINT SIGTERM

# ******************************************************************************
# ä¸»ç¨‹åºå¾ªç¯
# ******************************************************************************
main() {
    # æƒé™æ ¡éªŒ (å¯é€‰ï¼Œå¦‚æœä¸æƒ³è®©érootç”¨æˆ·è¿è¡Œä¸»èœå•)
    # is_root || ui_warn "å½“å‰é root ç”¨æˆ·è¿è¡Œï¼Œéƒ¨åˆ†åŠŸèƒ½å¯èƒ½å—é™ã€‚"

    while true; do
        ui clear
        ui print home_header "$(ui_spaces 1)ğŸ§°$(ui_spaces)ä¸€æ¬¾å…¨åŠŸèƒ½çš„ Linux ç®¡ç†è„šæœ¬ï¼ v$VSK_VERSION"
        ui print tip "$(ui_spaces 1)ğŸ’¡$(ui_spaces)Tip: å‘½ä»¤è¡Œè¾“å…¥ ${BOLD_GREEN}v${LIGHT_YELLOW} å¯å¿«é€Ÿå¯åŠ¨è„šæœ¬"
        # --- èœå•åŒºåŸŸ ---
        ui line
        # ç³»ç»Ÿå·¥å…·èœå•é¡¹
        ui item 1 "ç³»ç»Ÿå·¥å…· â–¶"
        ui item 2 "${BOLD_GREY}åŸºç¡€å·¥å…·${RESET}"
        ui item 3 "${BOLD_GREY}è¿›é˜¶å·¥å…·${RESET}"
        ui item 4 "Docker ç®¡ç† â–¶"
        ui line
        ui item 8 "æµ‹è¯•è„šæœ¬åˆé›† â–¶"
        ui item 9 "èŠ‚ç‚¹æ­å»ºè„šæœ¬ â–¶"
        ui line
        ui item 99 "è„šæœ¬è‡ªç®¡ç† â–¶"
        ui border_bottom
        ui item 0 "é€€å‡ºç¨‹åº"
        ui border_bottom

        # --- äº¤äº’é€»è¾‘ ---
        choice=$(ui_read_choice)

        case "$choice" in
            1|2|3|4|8|9|99)
                echo -e "$choice"
                # è°ƒç”¨ lib/router.sh ä¸­çš„åˆ†å‘å‡½æ•°
                router_main "$choice"
                ;;
            0)
                ui_exit
                ;;
            *)
                ui_error "æ— æ•ˆé€‰é¡¹ï¼Œè¯·é‡æ–°è¾“å…¥"
                sleep 1
                ;;
        esac
    done
}

# å¯åŠ¨ä¸»å‡½æ•°
main "$@"

# # ******************************************************************************
# # 3. å‘½ä»¤è¡Œå‚æ•°é¢„å¤„ç†
# # ******************************************************************************
# # å¤„ç†é€šè¿‡ bin/v ä¼ å…¥çš„å‚æ•°ï¼Œä¾‹å¦‚ï¼šv --update æˆ– v --version
# case "${1:-}" in
#     --update|-u)
#         if [[ -f "${BASE_DIR}/update.sh" ]]; then
#             bash "${BASE_DIR}/update.sh"
#             exit 0
#         fi
#         ;;
#     --version|-v)
#         echo "VpsScriptKit Version: $VSK_VERSION"
#         exit 0
#     ;;
# esac
