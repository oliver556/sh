#!/usr/bin/env bash

# ==============================================================================
# VpsScriptKit - ä¸»å…¥å£
# 
# @æ–‡ä»¶è·¯å¾„: main.sh
# @åŠŸèƒ½æè¿°: ç¯å¢ƒåˆå§‹åŒ–ã€ä¾èµ–åŠ è½½ã€ä¸»èœå•æ¸²æŸ“ä¸è·¯ç”±åˆ†å‘
# 
# @ä½œè€…:    Jamison
# @ç‰ˆæœ¬:    1.0.0
# @åˆ›å»ºæ—¥æœŸ: 2026-01-09
# ==============================================================================

# ******************************************************************************
# Shell ç¯å¢ƒå®‰å…¨è®¾ç½®ï¼ˆå·¥ç¨‹çº§ï¼‰
# ******************************************************************************
# å¼€å¯é”™è¯¯è°ƒè¯•æ•æ‰ï¼šä¸€æ—¦å‡ºé”™ï¼Œæ‰“å°è¡Œå·å’Œé”™è¯¯å‘½ä»¤
trap 'echo -e "\033[31m[Error] è„šæœ¬å¼‚å¸¸é€€å‡ºï¼å‡ºé”™è¡Œå·: $LINENOï¼Œé”™è¯¯å‘½ä»¤: $BASH_COMMAND\033[0m"' ERR

set -o errexit   # ä¸€æ—¦æœ‰å‘½ä»¤è¿”å›é 0ï¼Œç«‹å³é€€å‡ºè„šæœ¬ï¼Œé¿å…é”™è¯¯è¢«å¿½ç•¥
set -o pipefail  # ç®¡é“ä¸­ä»»æ„ä¸€æ®µå¤±è´¥ï¼Œæ•´ä½“å¤±è´¥ï¼Œé˜²æ­¢é”™è¯¯è¢«åæ‰
set -o nounset   # ä½¿ç”¨æœªå®šä¹‰å˜é‡æ—¶ç›´æ¥æŠ¥é”™ï¼Œé¿å…æ‹¼å†™é”™è¯¯å¯¼è‡´éšè”½ bug

# ******************************************************************************
# åŸºç¡€è·¯å¾„ä¸ç¯å¢ƒå®šä¹‰
# ******************************************************************************

# å¯¼å…¥ç¯å¢ƒå˜é‡
source "$(dirname "${BASH_SOURCE[0]}")/lib/env.sh"

# æ£€æµ‹ç³»ç»Ÿæ˜¯å¦æ”¯æŒæœ¬è„šæœ¬
# check_supported_os

source "${BASE_DIR}/modules/system/maintain/menu.sh"

# ------------------------------------------------------------------------------
# å‡½æ•°å: _cleanup
# åŠŸèƒ½:  æ•æ‰é”™è¯¯çš„é€€å‡º
# 
# å‚æ•°: æ— 
# 
# è¿”å›å€¼:
#   0 - é”™è¯¯æ—¶çš„ä¿¡æ¯æç¤º
# 
# ç¤ºä¾‹:
#   _cleanup
# ------------------------------------------------------------------------------
_cleanup() {
  ui_exit
}
trap _cleanup SIGINT SIGTERM

# ******************************************************************************
# ä¸»ç¨‹åºå¾ªç¯
# ******************************************************************************
main() {
    # æƒé™æ ¡éªŒ (å¯é€‰ï¼Œå¦‚æœä¸æƒ³è®©érootç”¨æˆ·è¿è¡Œä¸»èœå•)
    # is_root || ui_warn "å½“å‰é root ç”¨æˆ·è¿è¡Œï¼Œéƒ¨åˆ†åŠŸèƒ½å¯èƒ½å—é™ã€‚"

    while true; do
        ui clear
        ui print home_header "$(ui_spaces 1)ğŸ§°$(ui_spaces)ä¸€æ¬¾å…¨åŠŸèƒ½çš„ Linux ç®¡ç†è„šæœ¬ï¼ v$VSK_VERSION"
        ui print tip "$(ui_spaces 1)ğŸ’¡$(ui_spaces)Tip: å‘½ä»¤è¡Œè¾“å…¥ ${BOLD_GREEN}v${LIGHT_YELLOW} å¯å¿«é€Ÿå¯åŠ¨è„šæœ¬"
        # --- èœå•åŒºåŸŸ ---
        ui line
        # ç³»ç»Ÿå·¥å…·èœå•é¡¹
        ui item 1 "ç³»ç»Ÿå·¥å…· â–¶"
        ui item 2 "${BOLD_GREY}åŸºç¡€å·¥å…·${RESET}"
        ui item 3 "${BOLD_GREY}è¿›é˜¶å·¥å…·${RESET}"
        ui item 4 "Docker ç®¡ç† â–¶"
        ui line
        ui item 8 "æµ‹è¯•è„šæœ¬åˆé›† â–¶"
        ui item 9 "èŠ‚ç‚¹æ­å»ºè„šæœ¬ â–¶"
        ui line
        ui item 99 "è„šæœ¬è‡ªç®¡ç† â–¶"
        ui border_bottom
        ui item 0 "é€€å‡ºç¨‹åº"
        ui border_bottom

        # --- äº¤äº’é€»è¾‘ ---
        choice=$(ui_read_choice)

        case "$choice" in
            1|2|3|4|8|9|99)
                if declare -f router_main > /dev/null; then
                    local ret=0
                    
                    # è°ƒç”¨è·¯ç”±åˆ†å‘ï¼Œå¹¶æ•è·è¿”å›å€¼
                    # ä½¿ç”¨ || ret=$? æ˜¯ä¸ºäº†é˜²æ­¢ set -e (å¦‚æœå¼€å¯) å¯¼è‡´è„šæœ¬ç›´æ¥é€€å‡º
                    router_main "$choice" || ret=$?

                    # æ£€æŸ¥è¿”å›å€¼æ˜¯å¦ä¸º 10 (é‡å¯ä¿¡å·)
                    if [[ $ret -eq 10 ]]; then
                        ui blank
                        ui echo "${BOLD_CYAN}ğŸ”„$(ui_spaces)ç³»ç»Ÿæ­£åœ¨é‡è½½ä¸»ç¨‹åº...${RESET}"
                        sleep 1
                        
                        # ç¡®ä¿æœ‰æ‰§è¡Œæƒé™
                        chmod +x "${BASE_DIR}/main.sh" 2>/dev/null
                        
                        # æ‰§è¡ŒåŸåœ°é‡å¯
                        # ä½¿ç”¨ exec æ›¿æ¢å½“å‰è¿›ç¨‹ï¼Œ"$0" ä»£è¡¨å½“å‰è„šæœ¬è·¯å¾„ï¼Œ"$@" ä»£è¡¨å¯åŠ¨å‚æ•°
                        exec bash "$0" "$@"
                    fi
                else
                    ui_error "è·¯ç”±å‡½æ•° router_main æœªæ‰¾åˆ°"
                    sleep 1
                fi
                ;;
            0)
                ui_exit
                ;;
            *)
                ui_error "æ— æ•ˆé€‰é¡¹ï¼Œè¯·é‡æ–°è¾“å…¥"
                sleep 1
                ;;
        esac
    done
}

# å¯åŠ¨ä¸»å‡½æ•°
main "$@"

# # ******************************************************************************
# # 3. å‘½ä»¤è¡Œå‚æ•°é¢„å¤„ç†
# # ******************************************************************************
# # å¤„ç†é€šè¿‡ bin/v ä¼ å…¥çš„å‚æ•°ï¼Œä¾‹å¦‚ï¼šv --update æˆ– v --version
# case "${1:-}" in
#     --update|-u)
#         if [[ -f "${BASE_DIR}/update.sh" ]]; then
#             bash "${BASE_DIR}/update.sh"
#             exit 0
#         fi
#         ;;
#     --version|-v)
#         echo "VpsScriptKit Version: $VSK_VERSION"
#         exit 0
#     ;;
# esac
