#!/usr/bin/env bash

# ==============================================================================
# VpsScriptKit - 修改系统用户密码
#
# @文件路径: modules/system/security/change_password.sh
# @功能描述:
#   提供安全的用户密码修改功能，支持 root 与非 root 用户
#
# @作者: Jamison
# @版本: 1.0.0
# @创建日期: 2026-01-12
# ==============================================================================

# ------------------------------------------------------------------------------
# 函数名: guard_change_password
# 功能:   修改密码前的前置检查（守卫函数）
# 
# 参数:
#   无
# 
# 返回值:
#   0 - 允许执行修改密码操作
#   1 - 不满足执行条件
# 
# 示例:
#   guard_change_password
# ------------------------------------------------------------------------------
guard_change_password() {
    ui clear

    if ! has_cmd passwd; then
        ui_error "系统未检测到 passwd 命令，无法修改密码"
        return 1
    fi
    
    change_password
    
    return 0
}

# ------------------------------------------------------------------------------
# 函数名: change_password
# 功能:   修改系统用户密码（行为型）
# 
# 参数:
#   $1 (string): 用户名（可选）
#               - root 用户：可指定其他用户
#               - 非 root 用户：忽略该参数，只能修改自身
# 
# 返回值:
#   0 - 密码修改成功
#   1 - 修改失败
# 
# 示例:
#   change_password
#   change_password "testuser"
# ------------------------------------------------------------------------------
change_password() {

    local target_user

    # --------------------------------------------------------------------------
    # 判断当前执行用户身份
    # --------------------------------------------------------------------------

    if is_root; then
        # root 用户

        if [[ -n "${1:-}" ]]; then
            # root 且指定了目标用户
            target_user="$1"
        else
            # root 未指定用户，默认修改 root 自身
            target_user="root"
        fi

    else
        # 非 root 用户只能修改自身密码
        target_user="$(whoami)"
    fi

    # --------------------------------------------------------------------------
    # 检查目标用户是否存在
    # --------------------------------------------------------------------------

    if ! id "$target_user" &>/dev/null; then
        ui_error "用户不存在: $target_user"
        return 1
    fi

    # --------------------------------------------------------------------------
    # 提示用户即将修改的账号
    # --------------------------------------------------------------------------

    if is_root; then
        ui_info "即将修改用户 [$target_user] 的登录密码"
    else
        ui_info "即将修改当前用户 [$target_user] 的登录密码"
    fi

    ui_warn "请输入新密码（输入过程不会显示）"

    # --------------------------------------------------------------------------
    # 执行密码修改
    # - root 可直接 passwd user
    # - 非 root passwd 不带参数
    # --------------------------------------------------------------------------

    if is_root; then
        # root 修改指定用户
        if ! passwd "$target_user"; then
            ui_error "密码修改失败"
            return 1
        fi
    else
        # 普通用户修改自身密码
        if ! passwd; then
            ui_error "密码修改失败"
            return 1
        fi
    fi

    # --------------------------------------------------------------------------
    # 修改成功
    # --------------------------------------------------------------------------

    ui_success "用户 [$target_user] 密码修改成功"
    return 0
}
