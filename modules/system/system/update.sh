#!/usr/bin/env bash

# ==============================================================================
# VpsScriptKit - 系统更新
#
# @文件路径: modules/system/system/update.sh
# @功能描述: 自动识别当前 Linux 系统可用的包管理器，并执行系统更新/升级
#
# @作者: Jamison
# @版本: 1.0.0
# @创建日期: 2026-01-12
# ==============================================================================

guard_system_update(){
    ui clear

    if system_update; then
        ui_box_success "系统更新已完成" "top"
    else
        ui_box_error "系统更新过程中出现错误"
    fi
}

# ------------------------------------------------------------------------------
# 函数名: system_update
# 功能:   执行系统软件包更新与升级（行为型）
# 
# 参数:
#   无
# 
# 返回值:
#   0 - 系统更新执行成功
#   1 - 系统不支持或更新过程中发生错误
# 
# 示例:
#   system_update
# ------------------------------------------------------------------------------
system_update() {
    local pkg_manager
    pkg_manager="$(os_get_pkg_manager)" || {
        # 如果无法识别包管理器，直接返回失败
        ui_error "当前系统未检测到支持的包管理器，无法执行系统更新"
        return 1
    }

    ui_box_info  "开始更新系统软件包..."
    # --------------------------------------------------------------------------
    # 根据不同包管理器，执行对应的系统更新逻辑
    # 所有命令均使用非交互模式，避免阻塞脚本执行
    # --------------------------------------------------------------------------
    case "$pkg_manager" in

        # ----------------------------------------------------------------------
        # Debian / Ubuntu 系列
        # ----------------------------------------------------------------------
        apt)
            # ui_info "检测到 apt 包管理器，开始更新系统软件包..."

            # 修复 dpkg 中断状态（防止清理失败）
            fix_dpkg

            # 使用非交互环境变量，避免 tzdata 等包阻塞
            if ! DEBIAN_FRONTEND=noninteractive apt update -y; then
                ui_error "apt 更新软件源失败"
                return 1
            fi

            # 执行完整升级（允许安装/移除依赖）
            if ! DEBIAN_FRONTEND=noninteractive apt full-upgrade -y; then
                ui_error "apt 系统升级失败"
                return 1
            fi
            ;;

        # ----------------------------------------------------------------------
        # RHEL 8+ / Fedora
        # ----------------------------------------------------------------------
        dnf)
            # ui_info "检测到 dnf 包管理器，开始更新系统软件包..."

            # 执行系统更新
            if ! dnf -y update; then
                ui_error "dnf 系统更新失败"
                return 1
            fi
            ;;

        # ----------------------------------------------------------------------
        # RHEL 7 / CentOS 7
        # ----------------------------------------------------------------------
        yum)
            # ui_info "检测到 yum 包管理器，开始更新系统软件包..."

            # 执行系统更新
            if ! yum -y update; then
                ui_error "yum 系统更新失败"
                return 1
            fi
            ;;

        # ----------------------------------------------------------------------
        # Alpine Linux
        # ----------------------------------------------------------------------
        apk)
            # ui_info "检测到 apk 包管理器，开始更新系统软件包..."

            # 更新软件包索引
            if ! apk update; then
                ui_error "apk 更新索引失败"
                return 1
            fi

            # 升级所有已安装包
            if ! apk upgrade; then
                ui_error "apk 系统升级失败"
                return 1
            fi
            ;;

        # ----------------------------------------------------------------------
        # Arch Linux
        # ----------------------------------------------------------------------
        pacman)
            # ui_info "检测到 pacman 包管理器，开始更新系统软件包..."

            # 同步并升级所有软件包
            if ! pacman -Syu --noconfirm; then
                ui_error "pacman 系统更新失败"
                return 1
            fi
            ;;

        # ----------------------------------------------------------------------
        # openSUSE
        # ----------------------------------------------------------------------
        zypper)
            # ui_info "检测到 zypper 包管理器，开始更新系统软件包..."

            # 刷新软件源
            if ! zypper refresh; then
                ui_error "zypper 刷新软件源失败"
                return 1
            fi

            # 执行系统升级
            if ! zypper update -y; then
                ui_error "zypper 系统更新失败"
                return 1
            fi
            ;;

        # ----------------------------------------------------------------------
        # OpenWrt / 嵌入式系统
        # ----------------------------------------------------------------------
        opkg)
            # ui_info "检测到 opkg 包管理器，开始更新系统软件包..."

            # 更新软件源
            if ! opkg update; then
                ui_error "opkg 更新软件源失败"
                return 1
            fi

            # 升级所有可升级包
            if ! opkg upgrade; then
                ui_error "opkg 系统更新失败"
                return 1
            fi
            ;;

        # ----------------------------------------------------------------------
        # 未支持的包管理器（理论上不会进入）
        # ----------------------------------------------------------------------
        *)
            ui_error "当前包管理器不受支持: $pkg_manager"
            return 1
            ;;
    esac

    return 0
}
