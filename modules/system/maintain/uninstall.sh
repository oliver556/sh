#!/usr/bin/env bash

# ==============================================================================
# VpsScriptKit - 卸载脚本
# 
# @文件路径: modules/system/maintain/uninstall.sh
# @功能描述: 卸载脚本逻辑
# 
# @作者:    Jamison
# @版本:    0.1.0
# @创建日期: 2026-01-07
# ==============================================================================

# ******************************************************************************
# Shell 环境安全设置（工程级）
# ******************************************************************************

# 严谨模式：遇到错误即退出
set -Eeuo pipefail
trap 'echo -e "\n${BOLD_RED}✘ 卸载过程中出现异常${NC}" >&2' ERR

# ******************************************************************************
# 环境初始化
# ******************************************************************************
source "${BASE_DIR}/lib/env.sh"

# ------------------------------------------------------------------------------
# 函数名: do_uninstall
# 功能:  卸载脚本
# 
# 参数: 无
# 
# 返回值:
#   0 - 取消卸载
#   1 - 执行卸载
# 
# 示例:
#   do_uninstall
# ------------------------------------------------------------------------------
do_uninstall() {
    # 权限检查
    if ! check_root; then
        return 1
    fi

    print_clear
    print_line -c "━"
    ui_warn "警告操作: 该操作将完全移除脚本文件及所有快捷命令。"
    print_line -c "━"

    # 交互确认
    if ! ui_confirm "确认继续卸载？"; then
        return 1
    fi

    print_blank
    print_step "正在清理系统..."
    print_blank

    # 清理快捷命令
    for path in "${BIN_PATHS[@]}"; do
        if [[ -e "$path" || -L "$path" ]]; then
            rm -f "$path" 2>/dev/null || true
        fi
    done

    # 移除主安装目录
    if [[ -d "$BASE_DIR" ]]; then
        rm -rf "$BASE_DIR" 2>/dev/null || true
    fi

    print_box_success -m "VpsScriptKit 所有组件已彻底卸载完成，感谢使用！江湖有缘再见！！！"
    sleep 1
    print_clear

    return 0
}


# 启动并捕获返回值，作为脚本退出码传递给 menu.sh
do_uninstall

exit $?
