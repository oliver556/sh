#!/usr/bin/env bash

# ==============================================================================
# VpsScriptKit - é‡è£…è„šæœ¬
# 
# @æ–‡ä»¶è·¯å¾„: modules/system/maintain/reinstall.sh
# @åŠŸèƒ½æè¿°: å¼ºåˆ¶é‡è£…æœ€æ–°ç‰ˆæœ¬è„šæœ¬
# 
# @ä½œè€…:    Jamison
# @ç‰ˆæœ¬:    0.1.0
# @åˆ›å»ºæ—¥æœŸ: 2026-01-09
# ==============================================================================

set -Eeuo pipefail

# ------------------------------------------------------------------------------
# å‡½æ•°å: _restart_script
# åŠŸèƒ½:   å®‰å…¨åœ°é‡å¯è„šæœ¬
# ------------------------------------------------------------------------------
_restart_script() {
    # ç¡®ä¿å…¥å£æ–‡ä»¶æœ‰æ‰§è¡Œæƒé™
    chmod +x "${BASE_DIR}/v" "${BASE_DIR}/main.sh" 2>/dev/null

    # ä¼˜å…ˆæ‰§è¡Œ vï¼Œå¦‚æœæ‰¾ä¸åˆ°åˆ™æ‰§è¡Œ main.sh
    if [[ -f "${BASE_DIR}/v" ]]; then
        exec "${BASE_DIR}/v"
    else
        exec "${BASE_DIR}/main.sh"
    fi
}

# ------------------------------------------------------------------------------
# å‡½æ•°å: do_reinstall
# åŠŸèƒ½:  å¼ºåˆ¶é‡æ–°å®‰è£…è„šæœ¬
# 
# å‚æ•°: æ— 
# 
# è¿”å›å€¼:
#   10 - æ›´æ–°æˆåŠŸï¼Œé€šçŸ¥ çˆ¶shell ï¼Œæˆ‘è¦è‡ªå·±æ‰§è¡Œé‡å¯
# 
# ç¤ºä¾‹:
#   do_reinstall
# ------------------------------------------------------------------------------
do_reinstall() {
    ui clear
    ui print info_header "æ­£åœ¨å¼ºåˆ¶é‡æ–°å®‰è£…å¹¶ä¿®å¤ç¯å¢ƒ..."
    ui blank

    # 1. ä½¿ç”¨ bash -s -- ä¼ é€’å‚æ•°ç»™è¿œç¨‹ä¸‹è½½çš„è„šæœ¬
    # 2. ä¼ é€’ --skip-agreement è®© install.sh è¯†åˆ«å¹¶è·³è¿‡ç¡®è®¤ç¯èŠ‚
    if curl -sL vsk.viplee.cc | bash -s -- --skip-agreement; then
        ui blank
        ui_success "å¼ºåˆ¶é‡æ–°å®‰è£…å®Œæˆï¼"
        ui echo "${BOLD_CYAN}ğŸ”„$(ui_spaces)è„šæœ¬å°†åœ¨ 2 ç§’ååŸåœ°é‡å¯...${RESET}"
        sleep 2
        # é‡æ–°è½½å…¥ä¸»ç¨‹åº
        # exec v
        exit 10
        # _restart_script
    else
        ui_error "å¼ºåˆ¶å®‰è£…è¿‡ç¨‹ä¸­å‡ºç°å¼‚å¸¸"
        ui_wait_enter
        exit 1
    fi
}

do_reinstall "$@"
