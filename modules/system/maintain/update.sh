#!/usr/bin/env bash

# ==============================================================================
# VpsScriptKit - æ ¸å¿ƒæ›´æ–°å¼•æ“ (ä¸å«èœå•ï¼Œåªè´Ÿè´£é€»è¾‘æ‰§è¡Œ)
# 
# @æ–‡ä»¶è·¯å¾„: modules/system/maintain/update.sh
# @åŠŸèƒ½æè¿°: ç¯å¢ƒåˆå§‹åŒ–ã€ä¾èµ–åŠ è½½ã€ä¸»èœå•æ¸²æŸ“ä¸è·¯ç”±åˆ†å‘
# 
# @ä½œè€…:    Jamison
# @ç‰ˆæœ¬:    0.1.0
# @åˆ›å»ºæ—¥æœŸ: 2026-01-06
# ==============================================================================

# ******************************************************************************
# Shell ç¯å¢ƒå®‰å…¨è®¾ç½®ï¼ˆå·¥ç¨‹çº§ï¼‰
# ******************************************************************************

# ä¸¥è°¨æ¨¡å¼ï¼šé‡åˆ°é”™è¯¯å³é€€å‡º
set -Eeuo pipefail
trap 'echo -e "${BOLD_RED}é”™è¯¯: æ›´æ–°åœ¨ç¬¬ $LINENO è¡Œå¤±è´¥${RESET}" >&2' ERR

# ******************************************************************************
# ç¯å¢ƒåˆå§‹åŒ–
# ******************************************************************************
source "${BASE_DIR}/lib/env.sh"

# ------------------------------------------------------------------------------
# å‡½æ•°å: get_versions
# åŠŸèƒ½:   è·å–ç‰ˆæœ¬
# å‚æ•°: æ— 
#
# è¿”å›å€¼:
#   LOCAL_VER - æœ¬åœ°ç‰ˆæœ¬
#   REMOTE_VER - è¿œç«¯ç‰ˆæœ¬
# 
# ç¤ºä¾‹:
#   get_versions
# ------------------------------------------------------------------------------
get_versions() {
    # è·å–æœ¬åœ°ç‰ˆæœ¬
    if [[ -f "${BASE_DIR}/version" ]]; then
        LOCAL_VER=$(cat "${BASE_DIR}/version" | xargs)
    else
        LOCAL_VER="Unknown"
    fi

    ui echo "${BOLD_CYAN}ğŸ”$(ui_spaces)æ­£åœ¨æ£€æŸ¥è¿œç¨‹ç‰ˆæœ¬...${RESET}"
    
    # è·å–è¿œç¨‹æœ€æ–°ç‰ˆæœ¬ (GitHub API)ï¼Œä½¿ç”¨ curl è·å–ï¼Œè®¾ç½®è¶…æ—¶æ—¶é—´é˜²æ­¢å¡æ­»
    REMOTE_VER=$(curl -fsSL --connect-timeout 5 "https://api.github.com/repos/$REPO/releases/latest" | grep '"tag_name":' | cut -d '"' -f 4 | xargs || echo "")

    if [[ -z "$REMOTE_VER" ]]; then
        ui_error "æ— æ³•è·å–è¿œç¨‹ç‰ˆæœ¬ä¿¡æ¯ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥ã€‚"
        return 1
    fi
    
    export LOCAL_VER
    export REMOTE_VER
}

# ------------------------------------------------------------------------------
# å‡½æ•°å: do_update
# åŠŸèƒ½:   æ‰§è¡Œæ›´æ–°ä¸åŸåœ°é‡å¯
# å‚æ•°: æ— 
#
# è¿”å›å€¼:
#   10 - æ›´æ–°æˆåŠŸï¼Œé€šçŸ¥ä¸»ç¨‹åºé‡å¯
# 
# ç¤ºä¾‹:
#   do_update
# ------------------------------------------------------------------------------
do_update() {
    ui clear
    ui print info_header "æ£€æŸ¥ç‰ˆæœ¬"
    ui blank

    # è·å–å¹¶æ¯”å¯¹ç‰ˆæœ¬
    if ! get_versions; then
        ui_wait_enter
        exit 1
    fi

    # ç‰ˆæœ¬æ¯”å¯¹
    if [[ "$LOCAL_VER" == "$REMOTE_VER" ]] || [[ "v$LOCAL_VER" == "$REMOTE_VER" ]]; then
        ui echo "${BOLD_GREEN}âœ…$(ui_spaces)å½“å‰å·²æ˜¯æœ€æ–°ç‰ˆæœ¬ ($LOCAL_VER)ã€‚${RESET}"
        ui_wait_enter
        exit 0
    else
        ui_tip "å‘ç°æ–°ç‰ˆæœ¬"
    fi

    ui blank
    ui_info "æ­£åœ¨æ‹‰å–æœ€æ–°ä»£ç ..."
    sleep 1
    
    # ç›´æ¥è°ƒç”¨è¿œç¨‹çš„ä¸€é”®å®‰è£…è„šæœ¬ï¼Œå¹¶ä¼ é€’è·³è¿‡åè®®å‚æ•°
    if curl -sL vsk.viplee.cc | bash -s -- --skip-agreement; then
        ui blank
        ui echo "${BOLD_GREEN}âœ…$(ui_spaces)æ›´æ–°å®Œæˆï¼${RESET}"
        sleep 1
        exit 10
    else
        ui_error "æ›´æ–°å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–ç¨åé‡è¯•ã€‚"
        ui_wait_enter
        exit 1
    fi
}

# å¯åŠ¨å¼•æ“
do_update "$@"